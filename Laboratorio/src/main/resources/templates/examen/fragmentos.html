<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
    <head th:replace="~{layout/layout :: head-admin}">
        <title>Laboratorio Clinico Calderon Piedra</title>
        <meta charset="UTF-8" />
    </head>
    <body>


        <section th:fragment="alertas">
            <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

            <script th:if="${success}" th:inline="javascript">
                Swal.fire({
                title: 'Éxito',
                        text: /*[[${success}]]*/,
                        icon: 'success',
                        confirmButtonText: 'Aceptar',
                        confirmButtonColor: '#1c94a4'
                });
            </script>

            <script th:if="${mensaje}" th:inline="javascript">
                Swal.fire({
                title: /*[[${tipo == 'success' ? 'Éxito' : (tipo == 'warning' ? 'Atención' : 'Error')}]]*/,
                        text: /*[[${mensaje}]]*/,
                        icon: /*[[${tipo}]]*/,
                        confirmButtonText: 'Aceptar',
                        confirmButtonColor: '#1c94a4'
                });
            </script>
        </section>

        <section th:fragment="main" id="main" class="main">

            <div class="pagetitle">
                <nav>
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a>Inicio</a></li>
                        <li class="breadcrumb-item">Exámenes</li>
                        <li class="breadcrumb-item active">Datos</li>
                    </ol>
                </nav>
            </div>

            <section class="section">
                <div class="row">
                    <div class="col-lg-12">

                        <div class="card">
                            <div class="card-body">

                                <div class="datatable-controls">
                                    <a th:href="@{/examen/agregar}" class="btn btn-primary">Agregar</a>                    
                                </div>

                                <div th:replace="~{examen/fragmentos :: busqueda}"></div>

                                <div class="card">
                                    <div class="card-body">
                                        <div class="catalog">
                                            <div class="test" th:each="e : ${examenes}">
                                                <!-- Header -->
                                                <div class="test-header">
                                                    <span class="code">[[${e.codigo}]]</span>
                                                    <h3>[[${e.nombre}]]</h3>
                                                </div>

                                                <!-- Body -->
                                                <div class="test-body">


                                                    <div class="test-info">
                                                        <div class="info-row">
                                                            <strong>Area:</strong> [[${e.area}]]
                                                        </div>
                                                        <div class="info-row">
                                                            <strong>Condiciones</strong> [[${e.condiciones}]]
                                                        </div>
                                                        <div class="info-row">
                                                            <strong>Precio</strong> $[[${e.precio}]]
                                                        </div>
                                                        <div class="info-row">
                                                            <strong>Rango</strong> [[${e.valorMinimo}]] - [[${e.valorMaximo}]] [[${e.unidad}]]
                                                        </div>
                                                        <div class="info-row description">
                                                            <strong>Estado</strong>
                                                            <span th:text="${e.activo} ? 'Activo' : 'Inactivo'"></span>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Footer -->
                                                <div class="test-footer">
                                                    <a th:href="@{/examen/modificar/{id}(id=${e.idExamen})}" class="btn-exam" title="Actualizar">
                                                        <i class="bi bi-pencil"></i>
                                                    </a>
                                                </div>
                                            </div> 
                                        </div> 
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>


        </section>

        <section th:fragment="form-examen" id="main" class="main">

            <div class="pagetitle">
                <nav>
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a>Inicio</a></li>
                        <li class="breadcrumb-item">Exámenes</li>
                        <li class="breadcrumb-item active">Registrar</li>
                    </ol>
                </nav>
            </div>

            <section class="section">
                <div class="row">
                    <div class="col-lg-12">

                        <div class="card">
                            <div class="card-body">

                                <!-- Logo -->
                                <div class="text-center mb-5" style="margin-top: 20px;">
                                    <img th:src="@{/assets/img/logo-1.png}" alt="Logo Laboratorio"
                                         class="logo-img" style="max-width: 150px;"
                                         onerror="this.style.display='none'" />
                                </div>

                                <h4 class="text-center mb-4" style="color: #1c94a4; font-weight: bold;">
                                    Registrar Examen
                                </h4>

                                <form th:action="@{/examen/guardar}" th:object="${examen}" method="post">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                                    <div class="row">

                                        <div class="col-md-6 mb-3">
                                            <label for="nombre" class="form-label">Nombre</label>
                                            <input type="text" class="form-control text-center" id="nombre" th:field="*{nombre}" 
                                                   required maxlength="100"
                                                   pattern="^[A-Za-zÁÉÍÓÚáéíóúñÑ ]+$"
                                                   title="Solo letras y espacios"/>
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label for="area" class="form-label">Área</label>
                                            <input type="text" class="form-control text-center" id="area" th:field="*{area}" 
                                                   required maxlength="50"
                                                   pattern="^[A-Za-zÁÉÍÓÚáéíóúñÑ ]+$"
                                                   title="Solo letras y espacios"/>
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label for="precio" class="form-label">Precio</label>
                                            <input type="number" step="0.01" class="form-control text-center" id="precio" th:field="*{precio}" required />
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label for="unidad" class="form-label">Unidad</label>
                                            <input type="text" class="form-control text-center" id="unidad" th:field="*{unidad}" maxlength="20" />
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label for="valorMinimo" class="form-label">Valor Mínimo</label>
                                            <input type="number" step="0.01" class="form-control text-center" id="valorMinimo" th:field="*{valorMinimo}" />
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label for="valorMaximo" class="form-label">Valor Máximo</label>
                                            <input type="number" step="0.01" class="form-control text-center" id="valorMaximo" th:field="*{valorMaximo}" />
                                        </div>

                                        <div class="col-md-12 mb-3">
                                            <label for="condiciones" class="form-label">Condiciones</label>
                                            <textarea class="form-control text-center" id="condiciones" th:field="*{condiciones}" 
                                                      maxlength="255" pattern="^[A-Za-zÁÉÍÓÚáéíóúñÑ ]*$" 
                                                      title="Solo letras y espacios" rows="3"></textarea>
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label for="activo" class="form-label">Estado</label>
                                            <select th:field="*{activo}" class="form-select text-center">
                                                <option value="">Seleccione...</option> <!-- valor vacío OK -->
                                                <option th:value="true">Activo</option>
                                                <option th:value="false">Inactivo</option>
                                            </select>

                                        </div>

                                        <!-- Mensaje de error -->
                                        <div th:if="${error}" class="alert alert-danger" style="margin-top: 30px;">
                                            <span th:text="${error}"></span>
                                        </div>

                                        <div class="col-12 text-center mt-3">
                                            <button type="submit" class="btn btn-save me-2">Guardar</button>
                                            <a th:href="@{/examen/examenes}" class="btn btn-cancel">Cancelar</a>
                                        </div>
                                    </div>
                                </form>

                            </div> 
                        </div> 

                    </div> 
                </div> 
            </section>

        </section>

        <!-- modificar -->
        <section th:fragment="modificar" id="main" class="main">

            <div class="pagetitle">
                <nav>
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a>Inicio</a></li>
                        <li class="breadcrumb-item">Exámenes</li>
                        <li class="breadcrumb-item active">Actualizar</li>
                    </ol>
                </nav>
            </div><!-- End Page Title -->
            <section class="section">
                <div class="row">
                    <div class="col-lg-12">


                        <div class="card">
                            <div class="card-body">


                                <div class="text-center mb-4" style="margin-top: 20px;">
                                    <img th:src="@{/assets/img/logo-1.png}" alt="Logo Laboratorio"
                                         class="logo-img" style="max-width: 150px;"
                                         onerror="this.style.display='none'" />
                                </div>


                                <!-- Title -->
                                <h4 class="text-center mb-4" style="color: #1c94a4; font-weight: bold;">
                                    Actualizar Examen
                                </h4>

                                <form th:action="@{/examen/actualizar}" th:object="${examen}" method="post">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                                    <input type="hidden" th:field="*{idExamen}" />

                                    <div class="row">

                                        <div class="col-md-6 mb-3">
                                            <label for="nombre" class="form-label">Nombre</label>
                                            <input type="text" class="form-control text-center" id="nombre" th:field="*{nombre}" 
                                                   required maxlength="100"
                                                   pattern="^[A-Za-zÁÉÍÓÚáéíóúñÑ ]+$"
                                                   title="Solo letras y espacios"/>
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label for="area" class="form-label">Área</label>
                                            <input type="text" class="form-control text-center" id="area" th:field="*{area}" 
                                                   required maxlength="50"
                                                   pattern="^[A-Za-zÁÉÍÓÚáéíóúñÑ ]+$"
                                                   title="Solo letras y espacios"/>
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label for="precio" class="form-label">Precio</label>
                                            <input type="number" step="0.01" class="form-control text-center" id="precio" th:field="*{precio}" required />
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label for="unidad" class="form-label">Unidad</label>
                                            <input type="text" class="form-control text-center" id="unidad" th:field="*{unidad}" maxlength="20" />
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label for="valorMinimo" class="form-label">Valor Mínimo</label>
                                            <input type="number" step="0.01" class="form-control text-center" id="valorMinimo" th:field="*{valorMinimo}" />
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label for="valorMaximo" class="form-label">Valor Máximo</label>
                                            <input type="number" step="0.01" class="form-control text-center" id="valorMaximo" th:field="*{valorMaximo}" />
                                        </div>

                                        <div class="col-md-12 mb-3">
                                            <label for="condiciones" class="form-label">Condiciones</label>
                                            <textarea class="form-control text-center" id="condiciones" th:field="*{condiciones}" 
                                                      maxlength="255" pattern="^[A-Za-zÁÉÍÓÚáéíóúñÑ ]*$" 
                                                      title="Solo letras y espacios" rows="3"></textarea>
                                        </div>

                                        <div class="col-md-6 mb-3">
                                            <label for="activo" class="form-label">Estado</label>
                                            <select th:field="*{activo}" class="form-select text-center">
                                                <option value="">Seleccione...</option>
                                                <option th:value="true" th:selected="*{activo} == true">Activo</option>
                                                <option th:value="false" th:selected="*{activo} == false">Inactivo</option>
                                            </select>
                                        </div>

                                        <!-- Mensaje de error -->
                                        <div th:if="${error}" class="alert alert-danger" style="margin-top: 20px;">
                                            <span th:text="${error}"></span>
                                        </div>

                                        <div th:if="${errores}" class="alert alert-danger" style="margin-top: 20px;">
                                            <ul>
                                                <li th:each="err : ${errores}" th:text="${err.defaultMessage}"></li>
                                            </ul>
                                        </div>

                                        <div class="col-12 text-center mt-3">
                                            <button type="submit" class="btn btn-save me-2">Actualizar</button>
                                            <a th:href="@{/examen/examenes}" class="btn btn-cancel">Cancelar</a>
                                        </div>
                                    </div>
                                </form>

                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </section>

        <section th:fragment="busqueda">
            <div class="d-flex mb-3">
                <input type="text" id="busquedaInput" class="form-control me-2"
                       placeholder="Buscar por nombre o área" />
            </div>
        </section>

        <section th:fragment="proforma" id="main" class="main">

            <div class="pagetitle">
                <nav>
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a>Inicio</a></li>
                        <li class="breadcrumb-item">Exámenes</li>
                        <li class="breadcrumb-item active">Proforma</li>
                    </ol>
                </nav>
            </div><!-- End Page Title -->

            <section class="section">
                <div class="row">
                    <div class="col-lg-12">

                        <div class="card">
                            <div class="card-body">

                                <div class="datatable-controls mb-3 d-flex justify-content-between">

                                    <p>Proforma</p>
                                </div>

                                <form th:action="@{/examen/mostrar}" method="post" id="formExamenes">
                                    <table class="table datatable align-middle text-center">
                                        <thead>
                                            <tr>
                                                <th></th>   
                                                <th>Nombre</th>            
                                                <th>Área</th>
                                                <th>Precio</th>
                                                <th>Unidad</th>
                                                <th>Rango</th>           
                                                <th>Condiciones</th>        
                                                <th>Activo</th>        

                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr th:each="e : ${examenes}">
                                                <td>
                                                    <input type="checkbox" name="seleccionados" th:value="${e.idExamen}" class="exam-check">
                                                </td>
                                                <td>[[${e.nombre}]]</td>
                                                <td>[[${e.area}]]</td>
                                                <td>[[${e.precio}]]</td>
                                                <td>[[${e.unidad}]]</td>
                                                <td>[[${e.valorMinimo}]] - [[${e.valorMaximo}]]</td>
                                                <td>[[${e.condiciones}]]</td>
                                                <td>
                                                    <span th:text="${e.activo} ? 'Activo' : 'Inactivo'"></span>
                                                </td>

                                            </tr>
                                        </tbody>
                                    </table>

                                    <div class="d-flex justify-content-between align-items-center mt-3">

                                        <button type="submit" class="btn btn-success">Continuar</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

        </section>

        <section th:fragment="vista-proforma" class="section">
            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="card-body">

                            <div class="datatable-controls">
                                <button id="btnRegistro" class="btn-register" type="button" 
                                        onclick="window.location.href = '@{/examen/proforma}'">
                                    Regresar
                                </button>                      
                            </div>

                            <div class="proforma-container">
                                <!-- Toolbar -->
                                <div class="proforma-toolbar">
                                    <div class="toolbar-left">

                                        <button class="btn-action" title="Print" onclick="imprimirProforma()">
                                            <i class="fa-solid fa-print"></i>
                                        </button>

                                        <button class="btn-action" title="Export PDF" onclick="exportarProformaPDF()" style="background:white; border:none; cursor:pointer; border-radius:4px; padding:8px 12px;">
                                            <i class="fa-solid fa-file-export" style="color:#1c94a4;"></i>
                                        </button>


                                    </div>
                                </div>

                                <!-- Header -->
                                <div class="proforma-header">
                                    <h2>Proforma</h2>
                                    <div class="proforma-info">
                                        <p><strong>Fecha:</strong> <span th:text="${fechaActual}"></span></p>


                                    </div>
                                </div>

                                <table class="proforma-table">
                                    <thead>
                                        <tr>
                                            <th>Codigo</th>
                                            <th>Nombre del Exámen</th>
                                            <th>Condiciones</th>
                                            <th>Precio</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="e : ${examenes}">
                                            <td th:text="${e.codigo}"></td>
                                            <td th:text="${e.nombre}"></td>

                                            <td th:text="${e.condiciones}"></td>
                                            <td th:text="${e.precio}"></td>
                                        </tr>
                                    </tbody>
                                </table>

                                <div class="proforma-total"> 
                                    <p><strong>Total:</strong> <span th:text="${total}"></span></p>
                                    </p>
                                </div>

                                <div class="proforma-footer">
                                    <p>Este formulario proforma es válido por 15 días a partir de la fecha de emisión.</p>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </section>


        <script>

            const selectAll = document.getElementById("selectAll");
            const checkboxes = document.querySelectorAll(".exam-check");
            const countSelected = document.getElementById("countSelected");
            selectAll.addEventListener("change", function (e) {
            checkboxes.forEach(ch => ch.checked = e.target.checked);
            actualizarContador();
            });
            checkboxes.forEach(ch => {
            ch.addEventListener("change", actualizarContador);
            });
            function actualizarContador() {
            const seleccionados = document.querySelectorAll(".exam-check:checked").length;
            countSelected.textContent = `${seleccionados} seleccionado${seleccionados !== 1 ? 's' : ''}`;
            selectAll.checked = (seleccionados === checkboxes.length);
            }
        </script>

        <div th:replace="~{layout/layout :: jsfiles-admin}"></div>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
            const inputs = document.querySelectorAll("input[pattern]");
            inputs.forEach(input => {
            input.addEventListener("input", () => {
            if (input.validity.patternMismatch) {
            input.setCustomValidity(input.title);
            } else {
            input.setCustomValidity("");
            }
            });
            });
            });
        </script>


    </body>
</html>
